import{P as Point,r as removeItems,E as ExtensionType,T as Ticker,U as UPDATE_PRIORITY,a as EventEmitter,w as warn,e as extensions,C as Container}from"./DemoScript.astro_astro_type_script_index_0_lang.DEdM3eRb.js";import"./webworkerAll.4AzDYmHs.js";import"./preload-helper.oD9tGONt.js";import"./colorToUniform.Db5An2aa.js";class FederatedEvent{constructor(manager){this.bubbles=!0,this.cancelBubble=!0,this.cancelable=!1,this.composed=!1,this.defaultPrevented=!1,this.eventPhase=FederatedEvent.prototype.NONE,this.propagationStopped=!1,this.propagationImmediatelyStopped=!1,this.layer=new Point,this.page=new Point,this.NONE=0,this.CAPTURING_PHASE=1,this.AT_TARGET=2,this.BUBBLING_PHASE=3,this.manager=manager}get layerX(){return this.layer.x}get layerY(){return this.layer.y}get pageX(){return this.page.x}get pageY(){return this.page.y}get data(){return this}composedPath(){return this.manager&&(!this.path||this.path[this.path.length-1]!==this.target)&&(this.path=this.target?this.manager.propagationPath(this.target):[]),this.path}initEvent(_type,_bubbles,_cancelable){throw new Error("initEvent() is a legacy DOM API. It is not implemented in the Federated Events API.")}initUIEvent(_typeArg,_bubblesArg,_cancelableArg,_viewArg,_detailArg){throw new Error("initUIEvent() is a legacy DOM API. It is not implemented in the Federated Events API.")}preventDefault(){this.nativeEvent instanceof Event&&this.nativeEvent.cancelable&&this.nativeEvent.preventDefault(),this.defaultPrevented=!0}stopImmediatePropagation(){this.propagationImmediatelyStopped=!0}stopPropagation(){this.propagationStopped=!0}}var appleIphone=/iPhone/i,appleIpod=/iPod/i,appleTablet=/iPad/i,appleUniversal=/\biOS-universal(?:.+)Mac\b/i,androidPhone=/\bAndroid(?:.+)Mobile\b/i,androidTablet=/Android/i,amazonPhone=/(?:SD4930UR|\bSilk(?:.+)Mobile\b)/i,amazonTablet=/Silk/i,windowsPhone=/Windows Phone/i,windowsTablet=/\bWindows(?:.+)ARM\b/i,otherBlackBerry=/BlackBerry/i,otherBlackBerry10=/BB10/i,otherOpera=/Opera Mini/i,otherChrome=/\b(CriOS|Chrome)(?:.+)Mobile/i,otherFirefox=/Mobile(?:.+)Firefox\b/i,isAppleTabletOnIos13=function(navigator2){return typeof navigator2<"u"&&navigator2.platform==="MacIntel"&&typeof navigator2.maxTouchPoints=="number"&&navigator2.maxTouchPoints>1&&typeof MSStream>"u"};function createMatch(userAgent){return function(regex){return regex.test(userAgent)}}function isMobile$1(param){var nav={userAgent:"",platform:"",maxTouchPoints:0};!param&&typeof navigator<"u"?nav={userAgent:navigator.userAgent,platform:navigator.platform,maxTouchPoints:navigator.maxTouchPoints||0}:typeof param=="string"?nav.userAgent=param:param&&param.userAgent&&(nav={userAgent:param.userAgent,platform:param.platform,maxTouchPoints:param.maxTouchPoints||0});var userAgent=nav.userAgent,tmp=userAgent.split("[FBAN");typeof tmp[1]<"u"&&(userAgent=tmp[0]),tmp=userAgent.split("Twitter"),typeof tmp[1]<"u"&&(userAgent=tmp[0]);var match=createMatch(userAgent),result={apple:{phone:match(appleIphone)&&!match(windowsPhone),ipod:match(appleIpod),tablet:!match(appleIphone)&&(match(appleTablet)||isAppleTabletOnIos13(nav))&&!match(windowsPhone),universal:match(appleUniversal),device:(match(appleIphone)||match(appleIpod)||match(appleTablet)||match(appleUniversal)||isAppleTabletOnIos13(nav))&&!match(windowsPhone)},amazon:{phone:match(amazonPhone),tablet:!match(amazonPhone)&&match(amazonTablet),device:match(amazonPhone)||match(amazonTablet)},android:{phone:!match(windowsPhone)&&match(amazonPhone)||!match(windowsPhone)&&match(androidPhone),tablet:!match(windowsPhone)&&!match(amazonPhone)&&!match(androidPhone)&&(match(amazonTablet)||match(androidTablet)),device:!match(windowsPhone)&&(match(amazonPhone)||match(amazonTablet)||match(androidPhone)||match(androidTablet))||match(/\bokhttp\b/i)},windows:{phone:match(windowsPhone),tablet:match(windowsTablet),device:match(windowsPhone)||match(windowsTablet)},other:{blackberry:match(otherBlackBerry),blackberry10:match(otherBlackBerry10),opera:match(otherOpera),firefox:match(otherFirefox),chrome:match(otherChrome),device:match(otherBlackBerry)||match(otherBlackBerry10)||match(otherOpera)||match(otherFirefox)||match(otherChrome)},any:!1,phone:!1,tablet:!1};return result.any=result.apple.device||result.android.device||result.windows.device||result.other.device,result.phone=result.apple.phone||result.android.phone||result.windows.phone,result.tablet=result.apple.tablet||result.android.tablet||result.windows.tablet,result}const isMobileCall=isMobile$1.default??isMobile$1,isMobile=isMobileCall(globalThis.navigator),KEY_CODE_TAB=9,DIV_TOUCH_SIZE=100,DIV_TOUCH_POS_X=0,DIV_TOUCH_POS_Y=0,DIV_TOUCH_ZINDEX=2,DIV_HOOK_SIZE=1,DIV_HOOK_POS_X=-1e3,DIV_HOOK_POS_Y=-1e3,DIV_HOOK_ZINDEX=2,_AccessibilitySystem=class _AccessibilitySystem2{constructor(renderer,_mobileInfo=isMobile){this._mobileInfo=_mobileInfo,this.debug=!1,this._activateOnTab=!0,this._deactivateOnMouseMove=!0,this._isActive=!1,this._isMobileAccessibility=!1,this._div=null,this._pool=[],this._renderId=0,this._children=[],this._androidUpdateCount=0,this._androidUpdateFrequency=500,this._hookDiv=null,(_mobileInfo.tablet||_mobileInfo.phone)&&this._createTouchHook(),this._renderer=renderer}get isActive(){return this._isActive}get isMobileAccessibility(){return this._isMobileAccessibility}get hookDiv(){return this._hookDiv}_createTouchHook(){const hookDiv=document.createElement("button");hookDiv.style.width=`${DIV_HOOK_SIZE}px`,hookDiv.style.height=`${DIV_HOOK_SIZE}px`,hookDiv.style.position="absolute",hookDiv.style.top=`${DIV_HOOK_POS_X}px`,hookDiv.style.left=`${DIV_HOOK_POS_Y}px`,hookDiv.style.zIndex=DIV_HOOK_ZINDEX.toString(),hookDiv.style.backgroundColor="#FF0000",hookDiv.title="select to enable accessibility for this content",hookDiv.addEventListener("focus",()=>{this._isMobileAccessibility=!0,this._activate(),this._destroyTouchHook()}),document.body.appendChild(hookDiv),this._hookDiv=hookDiv}_destroyTouchHook(){this._hookDiv&&(document.body.removeChild(this._hookDiv),this._hookDiv=null)}_activate(){if(this._isActive)return;this._isActive=!0,this._div||(this._div=document.createElement("div"),this._div.style.width=`${DIV_TOUCH_SIZE}px`,this._div.style.height=`${DIV_TOUCH_SIZE}px`,this._div.style.position="absolute",this._div.style.top=`${DIV_TOUCH_POS_X}px`,this._div.style.left=`${DIV_TOUCH_POS_Y}px`,this._div.style.zIndex=DIV_TOUCH_ZINDEX.toString(),this._div.style.pointerEvents="none"),this._activateOnTab&&(this._onKeyDown=this._onKeyDown.bind(this),globalThis.addEventListener("keydown",this._onKeyDown,!1)),this._deactivateOnMouseMove&&(this._onMouseMove=this._onMouseMove.bind(this),globalThis.document.addEventListener("mousemove",this._onMouseMove,!0));const canvas=this._renderer.view.canvas;if(canvas.parentNode)canvas.parentNode.appendChild(this._div),this._initAccessibilitySetup();else{const observer=new MutationObserver(()=>{canvas.parentNode&&(canvas.parentNode.appendChild(this._div),observer.disconnect(),this._initAccessibilitySetup())});observer.observe(document.body,{childList:!0,subtree:!0})}}_initAccessibilitySetup(){this._renderer.runners.postrender.add(this),this._renderer.lastObjectRendered&&this._updateAccessibleObjects(this._renderer.lastObjectRendered)}_deactivate(){if(!(!this._isActive||this._isMobileAccessibility)){this._isActive=!1,globalThis.document.removeEventListener("mousemove",this._onMouseMove,!0),this._activateOnTab&&globalThis.addEventListener("keydown",this._onKeyDown,!1),this._renderer.runners.postrender.remove(this);for(const child of this._children)child._accessibleDiv&&child._accessibleDiv.parentNode&&(child._accessibleDiv.parentNode.removeChild(child._accessibleDiv),child._accessibleDiv=null),child._accessibleActive=!1;this._pool.forEach(div=>{div.parentNode&&div.parentNode.removeChild(div)}),this._div&&this._div.parentNode&&this._div.parentNode.removeChild(this._div),this._pool=[],this._children=[]}}_updateAccessibleObjects(container){if(!container.visible||!container.accessibleChildren)return;container.accessible&&(container._accessibleActive||this._addChild(container),container._renderId=this._renderId);const children=container.children;if(children)for(let i=0;i<children.length;i++)this._updateAccessibleObjects(children[i])}init(options){const mergedOptions={accessibilityOptions:{..._AccessibilitySystem2.defaultOptions,...options?.accessibilityOptions||{}}};this.debug=mergedOptions.accessibilityOptions.debug,this._activateOnTab=mergedOptions.accessibilityOptions.activateOnTab,this._deactivateOnMouseMove=mergedOptions.accessibilityOptions.deactivateOnMouseMove,mergedOptions.accessibilityOptions.enabledByDefault?this._activate():this._activateOnTab&&(this._onKeyDown=this._onKeyDown.bind(this),globalThis.addEventListener("keydown",this._onKeyDown,!1)),this._renderer.runners.postrender.remove(this)}postrender(){const now=performance.now();if(this._mobileInfo.android.device&&now<this._androidUpdateCount||(this._androidUpdateCount=now+this._androidUpdateFrequency,!this._renderer.renderingToScreen||!this._renderer.view.canvas))return;const activeIds=new Set;if(this._renderer.lastObjectRendered){this._updateAccessibleObjects(this._renderer.lastObjectRendered);for(const child of this._children)child._renderId===this._renderId&&activeIds.add(this._children.indexOf(child))}for(let i=this._children.length-1;i>=0;i--){const child=this._children[i];activeIds.has(i)||(child._accessibleDiv&&child._accessibleDiv.parentNode&&(child._accessibleDiv.parentNode.removeChild(child._accessibleDiv),this._pool.push(child._accessibleDiv),child._accessibleDiv=null),child._accessibleActive=!1,removeItems(this._children,i,1))}if(this._renderer.renderingToScreen){const{x,y,width:viewWidth,height:viewHeight}=this._renderer.screen,div=this._div;div.style.left=`${x}px`,div.style.top=`${y}px`,div.style.width=`${viewWidth}px`,div.style.height=`${viewHeight}px`}for(let i=0;i<this._children.length;i++){const child=this._children[i];if(!child._accessibleActive||!child._accessibleDiv)continue;const div=child._accessibleDiv,hitArea=child.hitArea||child.getBounds().rectangle;if(child.hitArea){const wt=child.worldTransform,sx=this._renderer.resolution,sy=this._renderer.resolution;div.style.left=`${(wt.tx+hitArea.x*wt.a)*sx}px`,div.style.top=`${(wt.ty+hitArea.y*wt.d)*sy}px`,div.style.width=`${hitArea.width*wt.a*sx}px`,div.style.height=`${hitArea.height*wt.d*sy}px`}else{this._capHitArea(hitArea);const sx=this._renderer.resolution,sy=this._renderer.resolution;div.style.left=`${hitArea.x*sx}px`,div.style.top=`${hitArea.y*sy}px`,div.style.width=`${hitArea.width*sx}px`,div.style.height=`${hitArea.height*sy}px`}}this._renderId++}_updateDebugHTML(div){div.innerHTML=`type: ${div.type}</br> title : ${div.title}</br> tabIndex: ${div.tabIndex}`}_capHitArea(hitArea){hitArea.x<0&&(hitArea.width+=hitArea.x,hitArea.x=0),hitArea.y<0&&(hitArea.height+=hitArea.y,hitArea.y=0);const{width:viewWidth,height:viewHeight}=this._renderer;hitArea.x+hitArea.width>viewWidth&&(hitArea.width=viewWidth-hitArea.x),hitArea.y+hitArea.height>viewHeight&&(hitArea.height=viewHeight-hitArea.y)}_addChild(container){let div=this._pool.pop();div||(container.accessibleType==="button"?div=document.createElement("button"):(div=document.createElement(container.accessibleType),div.style.cssText=`
                        color: transparent;
                        pointer-events: none;
                        padding: 0;
                        margin: 0;
                        border: 0;
                        outline: 0;
                        background: transparent;
                        box-sizing: border-box;
                        user-select: none;
                        -webkit-user-select: none;
                        -moz-user-select: none;
                        -ms-user-select: none;
                    `,container.accessibleText&&(div.innerText=container.accessibleText)),div.style.width=`${DIV_TOUCH_SIZE}px`,div.style.height=`${DIV_TOUCH_SIZE}px`,div.style.backgroundColor=this.debug?"rgba(255,255,255,0.5)":"transparent",div.style.position="absolute",div.style.zIndex=DIV_TOUCH_ZINDEX.toString(),div.style.borderStyle="none",navigator.userAgent.toLowerCase().includes("chrome")?div.setAttribute("aria-live","off"):div.setAttribute("aria-live","polite"),navigator.userAgent.match(/rv:.*Gecko\//)?div.setAttribute("aria-relevant","additions"):div.setAttribute("aria-relevant","text"),div.addEventListener("click",this._onClick.bind(this)),div.addEventListener("focus",this._onFocus.bind(this)),div.addEventListener("focusout",this._onFocusOut.bind(this))),div.style.pointerEvents=container.accessiblePointerEvents,div.type=container.accessibleType,container.accessibleTitle&&container.accessibleTitle!==null?div.title=container.accessibleTitle:(!container.accessibleHint||container.accessibleHint===null)&&(div.title=`container ${container.tabIndex}`),container.accessibleHint&&container.accessibleHint!==null&&div.setAttribute("aria-label",container.accessibleHint),this.debug&&this._updateDebugHTML(div),container._accessibleActive=!0,container._accessibleDiv=div,div.container=container,this._children.push(container),this._div.appendChild(container._accessibleDiv),container.interactive&&(container._accessibleDiv.tabIndex=container.tabIndex)}_dispatchEvent(e,type){const{container:target}=e.target,boundary=this._renderer.events.rootBoundary,event=Object.assign(new FederatedEvent(boundary),{target});boundary.rootTarget=this._renderer.lastObjectRendered,type.forEach(type2=>boundary.dispatchEvent(event,type2))}_onClick(e){this._dispatchEvent(e,["click","pointertap","tap"])}_onFocus(e){e.target.getAttribute("aria-live")||e.target.setAttribute("aria-live","assertive"),this._dispatchEvent(e,["mouseover"])}_onFocusOut(e){e.target.getAttribute("aria-live")||e.target.setAttribute("aria-live","polite"),this._dispatchEvent(e,["mouseout"])}_onKeyDown(e){e.keyCode!==KEY_CODE_TAB||!this._activateOnTab||this._activate()}_onMouseMove(e){e.movementX===0&&e.movementY===0||this._deactivate()}destroy(){this._deactivate(),this._destroyTouchHook(),this._div=null,this._pool=null,this._children=null,this._renderer=null,this._activateOnTab&&globalThis.removeEventListener("keydown",this._onKeyDown)}setAccessibilityEnabled(enabled){enabled?this._activate():this._deactivate()}};_AccessibilitySystem.extension={type:[ExtensionType.WebGLSystem,ExtensionType.WebGPUSystem],name:"accessibility"};_AccessibilitySystem.defaultOptions={enabledByDefault:!1,debug:!1,activateOnTab:!0,deactivateOnMouseMove:!0};let AccessibilitySystem=_AccessibilitySystem;const accessibilityTarget={accessible:!1,accessibleTitle:null,accessibleHint:null,tabIndex:0,accessibleType:"button",accessibleText:null,accessiblePointerEvents:"auto",accessibleChildren:!0,_accessibleActive:!1,_accessibleDiv:null,_renderId:-1};class DOMPipe{constructor(renderer){this._attachedDomElements=[],this._renderer=renderer,this._renderer.runners.postrender.add(this),this._domElement=document.createElement("div"),this._domElement.style.position="absolute",this._domElement.style.top="0",this._domElement.style.left="0",this._domElement.style.pointerEvents="none",this._domElement.style.zIndex="1000"}addRenderable(domContainer,_instructionSet){this._attachedDomElements.includes(domContainer)||this._attachedDomElements.push(domContainer)}updateRenderable(_domContainer){}validateRenderable(_domContainer){return!0}postrender(){const attachedDomElements=this._attachedDomElements;if(attachedDomElements.length===0){this._domElement.remove();return}const canvas=this._renderer.view.canvas;this._domElement.parentNode!==canvas.parentNode&&canvas.parentNode?.appendChild(this._domElement);const sx=parseFloat(canvas.style.width)/canvas.width*this._renderer.resolution,sy=parseFloat(canvas.style.height)/canvas.height*this._renderer.resolution;this._domElement.style.transform=`translate(${canvas.offsetLeft}px, ${canvas.offsetTop}px) scale(${sx}, ${sy})`;for(let i=0;i<attachedDomElements.length;i++){const domContainer=attachedDomElements[i],element=domContainer.element;if(!domContainer.parent||domContainer.globalDisplayStatus<7)element?.remove(),attachedDomElements.splice(i,1),i--;else{this._domElement.contains(element)||(element.style.position="absolute",element.style.pointerEvents="auto",this._domElement.appendChild(element));const wt=domContainer.worldTransform,anchor=domContainer._anchor,ax=domContainer.width*anchor.x,ay=domContainer.height*anchor.y;element.style.transformOrigin=`${ax}px ${ay}px`,element.style.transform=`matrix(${wt.a}, ${wt.b}, ${wt.c}, ${wt.d}, ${wt.tx-ax}, ${wt.ty-ay})`,element.style.opacity=domContainer.groupAlpha.toString()}}}destroy(){this._renderer.runners.postrender.remove(this);for(let i=0;i<this._attachedDomElements.length;i++)this._attachedDomElements[i].element?.remove();this._attachedDomElements.length=0,this._domElement.remove(),this._renderer=null}}DOMPipe.extension={type:[ExtensionType.WebGLPipes,ExtensionType.WebGPUPipes,ExtensionType.CanvasPipes],name:"dom"};class EventsTickerClass{constructor(){this.interactionFrequency=10,this._deltaTime=0,this._didMove=!1,this._tickerAdded=!1,this._pauseUpdate=!0}init(events){this.removeTickerListener(),this.events=events,this.interactionFrequency=10,this._deltaTime=0,this._didMove=!1,this._tickerAdded=!1,this._pauseUpdate=!0}get pauseUpdate(){return this._pauseUpdate}set pauseUpdate(paused){this._pauseUpdate=paused}addTickerListener(){this._tickerAdded||!this.domElement||(Ticker.system.add(this._tickerUpdate,this,UPDATE_PRIORITY.INTERACTION),this._tickerAdded=!0)}removeTickerListener(){this._tickerAdded&&(Ticker.system.remove(this._tickerUpdate,this),this._tickerAdded=!1)}pointerMoved(){this._didMove=!0}_update(){if(!this.domElement||this._pauseUpdate)return;if(this._didMove){this._didMove=!1;return}const rootPointerEvent=this.events._rootPointerEvent;this.events.supportsTouchEvents&&rootPointerEvent.pointerType==="touch"||globalThis.document.dispatchEvent(this.events.supportsPointerEvents?new PointerEvent("pointermove",{clientX:rootPointerEvent.clientX,clientY:rootPointerEvent.clientY,pointerType:rootPointerEvent.pointerType,pointerId:rootPointerEvent.pointerId}):new MouseEvent("mousemove",{clientX:rootPointerEvent.clientX,clientY:rootPointerEvent.clientY}))}_tickerUpdate(ticker){this._deltaTime+=ticker.deltaTime,!(this._deltaTime<this.interactionFrequency)&&(this._deltaTime=0,this._update())}}const EventsTicker=new EventsTickerClass;class FederatedMouseEvent extends FederatedEvent{constructor(){super(...arguments),this.client=new Point,this.movement=new Point,this.offset=new Point,this.global=new Point,this.screen=new Point}get clientX(){return this.client.x}get clientY(){return this.client.y}get x(){return this.clientX}get y(){return this.clientY}get movementX(){return this.movement.x}get movementY(){return this.movement.y}get offsetX(){return this.offset.x}get offsetY(){return this.offset.y}get globalX(){return this.global.x}get globalY(){return this.global.y}get screenX(){return this.screen.x}get screenY(){return this.screen.y}getLocalPosition(container,point,globalPos){return container.worldTransform.applyInverse(globalPos||this.global,point)}getModifierState(key){return"getModifierState"in this.nativeEvent&&this.nativeEvent.getModifierState(key)}initMouseEvent(_typeArg,_canBubbleArg,_cancelableArg,_viewArg,_detailArg,_screenXArg,_screenYArg,_clientXArg,_clientYArg,_ctrlKeyArg,_altKeyArg,_shiftKeyArg,_metaKeyArg,_buttonArg,_relatedTargetArg){throw new Error("Method not implemented.")}}class FederatedPointerEvent extends FederatedMouseEvent{constructor(){super(...arguments),this.width=0,this.height=0,this.isPrimary=!1}getCoalescedEvents(){return this.type==="pointermove"||this.type==="mousemove"||this.type==="touchmove"?[this]:[]}getPredictedEvents(){throw new Error("getPredictedEvents is not supported!")}}class FederatedWheelEvent extends FederatedMouseEvent{constructor(){super(...arguments),this.DOM_DELTA_PIXEL=0,this.DOM_DELTA_LINE=1,this.DOM_DELTA_PAGE=2}}FederatedWheelEvent.DOM_DELTA_PIXEL=0;FederatedWheelEvent.DOM_DELTA_LINE=1;FederatedWheelEvent.DOM_DELTA_PAGE=2;const PROPAGATION_LIMIT=2048,tempHitLocation=new Point,tempLocalMapping=new Point;class EventBoundary{constructor(rootTarget){this.dispatch=new EventEmitter,this.moveOnAll=!1,this.enableGlobalMoveEvents=!0,this.mappingState={trackingData:{}},this.eventPool=new Map,this._allInteractiveElements=[],this._hitElements=[],this._isPointerMoveEvent=!1,this.rootTarget=rootTarget,this.hitPruneFn=this.hitPruneFn.bind(this),this.hitTestFn=this.hitTestFn.bind(this),this.mapPointerDown=this.mapPointerDown.bind(this),this.mapPointerMove=this.mapPointerMove.bind(this),this.mapPointerOut=this.mapPointerOut.bind(this),this.mapPointerOver=this.mapPointerOver.bind(this),this.mapPointerUp=this.mapPointerUp.bind(this),this.mapPointerUpOutside=this.mapPointerUpOutside.bind(this),this.mapWheel=this.mapWheel.bind(this),this.mappingTable={},this.addEventMapping("pointerdown",this.mapPointerDown),this.addEventMapping("pointermove",this.mapPointerMove),this.addEventMapping("pointerout",this.mapPointerOut),this.addEventMapping("pointerleave",this.mapPointerOut),this.addEventMapping("pointerover",this.mapPointerOver),this.addEventMapping("pointerup",this.mapPointerUp),this.addEventMapping("pointerupoutside",this.mapPointerUpOutside),this.addEventMapping("wheel",this.mapWheel)}addEventMapping(type,fn){this.mappingTable[type]||(this.mappingTable[type]=[]),this.mappingTable[type].push({fn,priority:0}),this.mappingTable[type].sort((a,b)=>a.priority-b.priority)}dispatchEvent(e,type){e.propagationStopped=!1,e.propagationImmediatelyStopped=!1,this.propagate(e,type),this.dispatch.emit(type||e.type,e)}mapEvent(e){if(!this.rootTarget)return;const mappers=this.mappingTable[e.type];if(mappers)for(let i=0,j=mappers.length;i<j;i++)mappers[i].fn(e);else warn(`[EventBoundary]: Event mapping not defined for ${e.type}`)}hitTest(x,y){EventsTicker.pauseUpdate=!0;const fn=this._isPointerMoveEvent&&this.enableGlobalMoveEvents?"hitTestMoveRecursive":"hitTestRecursive",invertedPath=this[fn](this.rootTarget,this.rootTarget.eventMode,tempHitLocation.set(x,y),this.hitTestFn,this.hitPruneFn);return invertedPath&&invertedPath[0]}propagate(e,type){if(!e.target)return;const composedPath=e.composedPath();e.eventPhase=e.CAPTURING_PHASE;for(let i=0,j=composedPath.length-1;i<j;i++)if(e.currentTarget=composedPath[i],this.notifyTarget(e,type),e.propagationStopped||e.propagationImmediatelyStopped)return;if(e.eventPhase=e.AT_TARGET,e.currentTarget=e.target,this.notifyTarget(e,type),!(e.propagationStopped||e.propagationImmediatelyStopped)){e.eventPhase=e.BUBBLING_PHASE;for(let i=composedPath.length-2;i>=0;i--)if(e.currentTarget=composedPath[i],this.notifyTarget(e,type),e.propagationStopped||e.propagationImmediatelyStopped)return}}all(e,type,targets=this._allInteractiveElements){if(targets.length===0)return;e.eventPhase=e.BUBBLING_PHASE;const events=Array.isArray(type)?type:[type];for(let i=targets.length-1;i>=0;i--)events.forEach(event=>{e.currentTarget=targets[i],this.notifyTarget(e,event)})}propagationPath(target){const propagationPath=[target];for(let i=0;i<PROPAGATION_LIMIT&&target!==this.rootTarget&&target.parent;i++){if(!target.parent)throw new Error("Cannot find propagation path to disconnected target");propagationPath.push(target.parent),target=target.parent}return propagationPath.reverse(),propagationPath}hitTestMoveRecursive(currentTarget,eventMode,location,testFn,pruneFn,ignore=!1){let shouldReturn=!1;if(this._interactivePrune(currentTarget))return null;if((currentTarget.eventMode==="dynamic"||eventMode==="dynamic")&&(EventsTicker.pauseUpdate=!1),currentTarget.interactiveChildren&&currentTarget.children){const children=currentTarget.children;for(let i=children.length-1;i>=0;i--){const child=children[i],nestedHit=this.hitTestMoveRecursive(child,this._isInteractive(eventMode)?eventMode:child.eventMode,location,testFn,pruneFn,ignore||pruneFn(currentTarget,location));if(nestedHit){if(nestedHit.length>0&&!nestedHit[nestedHit.length-1].parent)continue;const isInteractive=currentTarget.isInteractive();(nestedHit.length>0||isInteractive)&&(isInteractive&&this._allInteractiveElements.push(currentTarget),nestedHit.push(currentTarget)),this._hitElements.length===0&&(this._hitElements=nestedHit),shouldReturn=!0}}}const isInteractiveMode=this._isInteractive(eventMode),isInteractiveTarget=currentTarget.isInteractive();return isInteractiveTarget&&isInteractiveTarget&&this._allInteractiveElements.push(currentTarget),ignore||this._hitElements.length>0?null:shouldReturn?this._hitElements:isInteractiveMode&&!pruneFn(currentTarget,location)&&testFn(currentTarget,location)?isInteractiveTarget?[currentTarget]:[]:null}hitTestRecursive(currentTarget,eventMode,location,testFn,pruneFn){if(this._interactivePrune(currentTarget)||pruneFn(currentTarget,location))return null;if((currentTarget.eventMode==="dynamic"||eventMode==="dynamic")&&(EventsTicker.pauseUpdate=!1),currentTarget.interactiveChildren&&currentTarget.children){const children=currentTarget.children,relativeLocation=location;for(let i=children.length-1;i>=0;i--){const child=children[i],nestedHit=this.hitTestRecursive(child,this._isInteractive(eventMode)?eventMode:child.eventMode,relativeLocation,testFn,pruneFn);if(nestedHit){if(nestedHit.length>0&&!nestedHit[nestedHit.length-1].parent)continue;const isInteractive=currentTarget.isInteractive();return(nestedHit.length>0||isInteractive)&&nestedHit.push(currentTarget),nestedHit}}}const isInteractiveMode=this._isInteractive(eventMode),isInteractiveTarget=currentTarget.isInteractive();return isInteractiveMode&&testFn(currentTarget,location)?isInteractiveTarget?[currentTarget]:[]:null}_isInteractive(int){return int==="static"||int==="dynamic"}_interactivePrune(container){return!container||!container.visible||!container.renderable||!container.measurable||container.eventMode==="none"||container.eventMode==="passive"&&!container.interactiveChildren}hitPruneFn(container,location){if(container.hitArea&&(container.worldTransform.applyInverse(location,tempLocalMapping),!container.hitArea.contains(tempLocalMapping.x,tempLocalMapping.y)))return!0;if(container.effects&&container.effects.length)for(let i=0;i<container.effects.length;i++){const effect=container.effects[i];if(effect.containsPoint&&!effect.containsPoint(location,this.hitTestFn))return!0}return!1}hitTestFn(container,location){return container.hitArea?!0:container?.containsPoint?(container.worldTransform.applyInverse(location,tempLocalMapping),container.containsPoint(tempLocalMapping)):!1}notifyTarget(e,type){if(!e.currentTarget.isInteractive())return;type??(type=e.type);const handlerKey=`on${type}`;e.currentTarget[handlerKey]?.(e);const key=e.eventPhase===e.CAPTURING_PHASE||e.eventPhase===e.AT_TARGET?`${type}capture`:type;this._notifyListeners(e,key),e.eventPhase===e.AT_TARGET&&this._notifyListeners(e,type)}mapPointerDown(from){if(!(from instanceof FederatedPointerEvent)){warn("EventBoundary cannot map a non-pointer event as a pointer event");return}const e=this.createPointerEvent(from);if(this.dispatchEvent(e,"pointerdown"),e.pointerType==="touch")this.dispatchEvent(e,"touchstart");else if(e.pointerType==="mouse"||e.pointerType==="pen"){const isRightButton=e.button===2;this.dispatchEvent(e,isRightButton?"rightdown":"mousedown")}const trackingData=this.trackingData(from.pointerId);trackingData.pressTargetsByButton[from.button]=e.composedPath(),this.freeEvent(e)}mapPointerMove(from){if(!(from instanceof FederatedPointerEvent)){warn("EventBoundary cannot map a non-pointer event as a pointer event");return}this._allInteractiveElements.length=0,this._hitElements.length=0,this._isPointerMoveEvent=!0;const e=this.createPointerEvent(from);this._isPointerMoveEvent=!1;const isMouse=e.pointerType==="mouse"||e.pointerType==="pen",trackingData=this.trackingData(from.pointerId),outTarget=this.findMountedTarget(trackingData.overTargets);if(trackingData.overTargets?.length>0&&outTarget!==e.target){const outType=from.type==="mousemove"?"mouseout":"pointerout",outEvent=this.createPointerEvent(from,outType,outTarget);if(this.dispatchEvent(outEvent,"pointerout"),isMouse&&this.dispatchEvent(outEvent,"mouseout"),!e.composedPath().includes(outTarget)){const leaveEvent=this.createPointerEvent(from,"pointerleave",outTarget);for(leaveEvent.eventPhase=leaveEvent.AT_TARGET;leaveEvent.target&&!e.composedPath().includes(leaveEvent.target);)leaveEvent.currentTarget=leaveEvent.target,this.notifyTarget(leaveEvent),isMouse&&this.notifyTarget(leaveEvent,"mouseleave"),leaveEvent.target=leaveEvent.target.parent;this.freeEvent(leaveEvent)}this.freeEvent(outEvent)}if(outTarget!==e.target){const overType=from.type==="mousemove"?"mouseover":"pointerover",overEvent=this.clonePointerEvent(e,overType);this.dispatchEvent(overEvent,"pointerover"),isMouse&&this.dispatchEvent(overEvent,"mouseover");let overTargetAncestor=outTarget?.parent;for(;overTargetAncestor&&overTargetAncestor!==this.rootTarget.parent&&overTargetAncestor!==e.target;)overTargetAncestor=overTargetAncestor.parent;if(!overTargetAncestor||overTargetAncestor===this.rootTarget.parent){const enterEvent=this.clonePointerEvent(e,"pointerenter");for(enterEvent.eventPhase=enterEvent.AT_TARGET;enterEvent.target&&enterEvent.target!==outTarget&&enterEvent.target!==this.rootTarget.parent;)enterEvent.currentTarget=enterEvent.target,this.notifyTarget(enterEvent),isMouse&&this.notifyTarget(enterEvent,"mouseenter"),enterEvent.target=enterEvent.target.parent;this.freeEvent(enterEvent)}this.freeEvent(overEvent)}const allMethods=[],allowGlobalPointerEvents=this.enableGlobalMoveEvents??!0;this.moveOnAll?allMethods.push("pointermove"):this.dispatchEvent(e,"pointermove"),allowGlobalPointerEvents&&allMethods.push("globalpointermove"),e.pointerType==="touch"&&(this.moveOnAll?allMethods.splice(1,0,"touchmove"):this.dispatchEvent(e,"touchmove"),allowGlobalPointerEvents&&allMethods.push("globaltouchmove")),isMouse&&(this.moveOnAll?allMethods.splice(1,0,"mousemove"):this.dispatchEvent(e,"mousemove"),allowGlobalPointerEvents&&allMethods.push("globalmousemove"),this.cursor=e.target?.cursor),allMethods.length>0&&this.all(e,allMethods),this._allInteractiveElements.length=0,this._hitElements.length=0,trackingData.overTargets=e.composedPath(),this.freeEvent(e)}mapPointerOver(from){if(!(from instanceof FederatedPointerEvent)){warn("EventBoundary cannot map a non-pointer event as a pointer event");return}const trackingData=this.trackingData(from.pointerId),e=this.createPointerEvent(from),isMouse=e.pointerType==="mouse"||e.pointerType==="pen";this.dispatchEvent(e,"pointerover"),isMouse&&this.dispatchEvent(e,"mouseover"),e.pointerType==="mouse"&&(this.cursor=e.target?.cursor);const enterEvent=this.clonePointerEvent(e,"pointerenter");for(enterEvent.eventPhase=enterEvent.AT_TARGET;enterEvent.target&&enterEvent.target!==this.rootTarget.parent;)enterEvent.currentTarget=enterEvent.target,this.notifyTarget(enterEvent),isMouse&&this.notifyTarget(enterEvent,"mouseenter"),enterEvent.target=enterEvent.target.parent;trackingData.overTargets=e.composedPath(),this.freeEvent(e),this.freeEvent(enterEvent)}mapPointerOut(from){if(!(from instanceof FederatedPointerEvent)){warn("EventBoundary cannot map a non-pointer event as a pointer event");return}const trackingData=this.trackingData(from.pointerId);if(trackingData.overTargets){const isMouse=from.pointerType==="mouse"||from.pointerType==="pen",outTarget=this.findMountedTarget(trackingData.overTargets),outEvent=this.createPointerEvent(from,"pointerout",outTarget);this.dispatchEvent(outEvent),isMouse&&this.dispatchEvent(outEvent,"mouseout");const leaveEvent=this.createPointerEvent(from,"pointerleave",outTarget);for(leaveEvent.eventPhase=leaveEvent.AT_TARGET;leaveEvent.target&&leaveEvent.target!==this.rootTarget.parent;)leaveEvent.currentTarget=leaveEvent.target,this.notifyTarget(leaveEvent),isMouse&&this.notifyTarget(leaveEvent,"mouseleave"),leaveEvent.target=leaveEvent.target.parent;trackingData.overTargets=null,this.freeEvent(outEvent),this.freeEvent(leaveEvent)}this.cursor=null}mapPointerUp(from){if(!(from instanceof FederatedPointerEvent)){warn("EventBoundary cannot map a non-pointer event as a pointer event");return}const now=performance.now(),e=this.createPointerEvent(from);if(this.dispatchEvent(e,"pointerup"),e.pointerType==="touch")this.dispatchEvent(e,"touchend");else if(e.pointerType==="mouse"||e.pointerType==="pen"){const isRightButton=e.button===2;this.dispatchEvent(e,isRightButton?"rightup":"mouseup")}const trackingData=this.trackingData(from.pointerId),pressTarget=this.findMountedTarget(trackingData.pressTargetsByButton[from.button]);let clickTarget=pressTarget;if(pressTarget&&!e.composedPath().includes(pressTarget)){let currentTarget=pressTarget;for(;currentTarget&&!e.composedPath().includes(currentTarget);){if(e.currentTarget=currentTarget,this.notifyTarget(e,"pointerupoutside"),e.pointerType==="touch")this.notifyTarget(e,"touchendoutside");else if(e.pointerType==="mouse"||e.pointerType==="pen"){const isRightButton=e.button===2;this.notifyTarget(e,isRightButton?"rightupoutside":"mouseupoutside")}currentTarget=currentTarget.parent}delete trackingData.pressTargetsByButton[from.button],clickTarget=currentTarget}if(clickTarget){const clickEvent=this.clonePointerEvent(e,"click");clickEvent.target=clickTarget,clickEvent.path=null,trackingData.clicksByButton[from.button]||(trackingData.clicksByButton[from.button]={clickCount:0,target:clickEvent.target,timeStamp:now});const clickHistory=trackingData.clicksByButton[from.button];if(clickHistory.target===clickEvent.target&&now-clickHistory.timeStamp<200?++clickHistory.clickCount:clickHistory.clickCount=1,clickHistory.target=clickEvent.target,clickHistory.timeStamp=now,clickEvent.detail=clickHistory.clickCount,clickEvent.pointerType==="mouse"){const isRightButton=clickEvent.button===2;this.dispatchEvent(clickEvent,isRightButton?"rightclick":"click")}else clickEvent.pointerType==="touch"&&this.dispatchEvent(clickEvent,"tap");this.dispatchEvent(clickEvent,"pointertap"),this.freeEvent(clickEvent)}this.freeEvent(e)}mapPointerUpOutside(from){if(!(from instanceof FederatedPointerEvent)){warn("EventBoundary cannot map a non-pointer event as a pointer event");return}const trackingData=this.trackingData(from.pointerId),pressTarget=this.findMountedTarget(trackingData.pressTargetsByButton[from.button]),e=this.createPointerEvent(from);if(pressTarget){let currentTarget=pressTarget;for(;currentTarget;)e.currentTarget=currentTarget,this.notifyTarget(e,"pointerupoutside"),e.pointerType==="touch"?this.notifyTarget(e,"touchendoutside"):(e.pointerType==="mouse"||e.pointerType==="pen")&&this.notifyTarget(e,e.button===2?"rightupoutside":"mouseupoutside"),currentTarget=currentTarget.parent;delete trackingData.pressTargetsByButton[from.button]}this.freeEvent(e)}mapWheel(from){if(!(from instanceof FederatedWheelEvent)){warn("EventBoundary cannot map a non-wheel event as a wheel event");return}const wheelEvent=this.createWheelEvent(from);this.dispatchEvent(wheelEvent),this.freeEvent(wheelEvent)}findMountedTarget(propagationPath){if(!propagationPath)return null;let currentTarget=propagationPath[0];for(let i=1;i<propagationPath.length&&propagationPath[i].parent===currentTarget;i++)currentTarget=propagationPath[i];return currentTarget}createPointerEvent(from,type,target){const event=this.allocateEvent(FederatedPointerEvent);return this.copyPointerData(from,event),this.copyMouseData(from,event),this.copyData(from,event),event.nativeEvent=from.nativeEvent,event.originalEvent=from,event.target=target??this.hitTest(event.global.x,event.global.y)??this._hitElements[0],typeof type=="string"&&(event.type=type),event}createWheelEvent(from){const event=this.allocateEvent(FederatedWheelEvent);return this.copyWheelData(from,event),this.copyMouseData(from,event),this.copyData(from,event),event.nativeEvent=from.nativeEvent,event.originalEvent=from,event.target=this.hitTest(event.global.x,event.global.y),event}clonePointerEvent(from,type){const event=this.allocateEvent(FederatedPointerEvent);return event.nativeEvent=from.nativeEvent,event.originalEvent=from.originalEvent,this.copyPointerData(from,event),this.copyMouseData(from,event),this.copyData(from,event),event.target=from.target,event.path=from.composedPath().slice(),event.type=type??event.type,event}copyWheelData(from,to){to.deltaMode=from.deltaMode,to.deltaX=from.deltaX,to.deltaY=from.deltaY,to.deltaZ=from.deltaZ}copyPointerData(from,to){from instanceof FederatedPointerEvent&&to instanceof FederatedPointerEvent&&(to.pointerId=from.pointerId,to.width=from.width,to.height=from.height,to.isPrimary=from.isPrimary,to.pointerType=from.pointerType,to.pressure=from.pressure,to.tangentialPressure=from.tangentialPressure,to.tiltX=from.tiltX,to.tiltY=from.tiltY,to.twist=from.twist)}copyMouseData(from,to){from instanceof FederatedMouseEvent&&to instanceof FederatedMouseEvent&&(to.altKey=from.altKey,to.button=from.button,to.buttons=from.buttons,to.client.copyFrom(from.client),to.ctrlKey=from.ctrlKey,to.metaKey=from.metaKey,to.movement.copyFrom(from.movement),to.screen.copyFrom(from.screen),to.shiftKey=from.shiftKey,to.global.copyFrom(from.global))}copyData(from,to){to.isTrusted=from.isTrusted,to.srcElement=from.srcElement,to.timeStamp=performance.now(),to.type=from.type,to.detail=from.detail,to.view=from.view,to.which=from.which,to.layer.copyFrom(from.layer),to.page.copyFrom(from.page)}trackingData(id){return this.mappingState.trackingData[id]||(this.mappingState.trackingData[id]={pressTargetsByButton:{},clicksByButton:{},overTarget:null}),this.mappingState.trackingData[id]}allocateEvent(constructor){this.eventPool.has(constructor)||this.eventPool.set(constructor,[]);const event=this.eventPool.get(constructor).pop()||new constructor(this);return event.eventPhase=event.NONE,event.currentTarget=null,event.defaultPrevented=!1,event.path=null,event.target=null,event}freeEvent(event){if(event.manager!==this)throw new Error("It is illegal to free an event not managed by this EventBoundary!");const constructor=event.constructor;this.eventPool.has(constructor)||this.eventPool.set(constructor,[]),this.eventPool.get(constructor).push(event)}_notifyListeners(e,type){const listeners=e.currentTarget._events[type];if(listeners)if("fn"in listeners)listeners.once&&e.currentTarget.removeListener(type,listeners.fn,void 0,!0),listeners.fn.call(listeners.context,e);else for(let i=0,j=listeners.length;i<j&&!e.propagationImmediatelyStopped;i++)listeners[i].once&&e.currentTarget.removeListener(type,listeners[i].fn,void 0,!0),listeners[i].fn.call(listeners[i].context,e)}}const MOUSE_POINTER_ID=1,TOUCH_TO_POINTER={touchstart:"pointerdown",touchend:"pointerup",touchendoutside:"pointerupoutside",touchmove:"pointermove",touchcancel:"pointercancel"},_EventSystem=class _EventSystem2{constructor(renderer){this.supportsTouchEvents="ontouchstart"in globalThis,this.supportsPointerEvents=!!globalThis.PointerEvent,this.domElement=null,this.resolution=1,this.renderer=renderer,this.rootBoundary=new EventBoundary(null),EventsTicker.init(this),this.autoPreventDefault=!0,this._eventsAdded=!1,this._rootPointerEvent=new FederatedPointerEvent(null),this._rootWheelEvent=new FederatedWheelEvent(null),this.cursorStyles={default:"inherit",pointer:"pointer"},this.features=new Proxy({..._EventSystem2.defaultEventFeatures},{set:(target,key,value)=>(key==="globalMove"&&(this.rootBoundary.enableGlobalMoveEvents=value),target[key]=value,!0)}),this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this),this._onPointerOverOut=this._onPointerOverOut.bind(this),this.onWheel=this.onWheel.bind(this)}static get defaultEventMode(){return this._defaultEventMode}init(options){const{canvas,resolution}=this.renderer;this.setTargetElement(canvas),this.resolution=resolution,_EventSystem2._defaultEventMode=options.eventMode??"passive",Object.assign(this.features,options.eventFeatures??{}),this.rootBoundary.enableGlobalMoveEvents=this.features.globalMove}resolutionChange(resolution){this.resolution=resolution}destroy(){this.setTargetElement(null),this.renderer=null,this._currentCursor=null}setCursor(mode){mode||(mode="default");let applyStyles=!0;if(globalThis.OffscreenCanvas&&this.domElement instanceof OffscreenCanvas&&(applyStyles=!1),this._currentCursor===mode)return;this._currentCursor=mode;const style=this.cursorStyles[mode];if(style)switch(typeof style){case"string":applyStyles&&(this.domElement.style.cursor=style);break;case"function":style(mode);break;case"object":applyStyles&&Object.assign(this.domElement.style,style);break}else applyStyles&&typeof mode=="string"&&!Object.prototype.hasOwnProperty.call(this.cursorStyles,mode)&&(this.domElement.style.cursor=mode)}get pointer(){return this._rootPointerEvent}_onPointerDown(nativeEvent){if(!this.features.click)return;this.rootBoundary.rootTarget=this.renderer.lastObjectRendered;const events=this._normalizeToPointerData(nativeEvent);this.autoPreventDefault&&events[0].isNormalized&&(nativeEvent.cancelable||!("cancelable"in nativeEvent))&&nativeEvent.preventDefault();for(let i=0,j=events.length;i<j;i++){const nativeEvent2=events[i],federatedEvent=this._bootstrapEvent(this._rootPointerEvent,nativeEvent2);this.rootBoundary.mapEvent(federatedEvent)}this.setCursor(this.rootBoundary.cursor)}_onPointerMove(nativeEvent){if(!this.features.move)return;this.rootBoundary.rootTarget=this.renderer.lastObjectRendered,EventsTicker.pointerMoved();const normalizedEvents=this._normalizeToPointerData(nativeEvent);for(let i=0,j=normalizedEvents.length;i<j;i++){const event=this._bootstrapEvent(this._rootPointerEvent,normalizedEvents[i]);this.rootBoundary.mapEvent(event)}this.setCursor(this.rootBoundary.cursor)}_onPointerUp(nativeEvent){if(!this.features.click)return;this.rootBoundary.rootTarget=this.renderer.lastObjectRendered;let target=nativeEvent.target;nativeEvent.composedPath&&nativeEvent.composedPath().length>0&&(target=nativeEvent.composedPath()[0]);const outside=target!==this.domElement?"outside":"",normalizedEvents=this._normalizeToPointerData(nativeEvent);for(let i=0,j=normalizedEvents.length;i<j;i++){const event=this._bootstrapEvent(this._rootPointerEvent,normalizedEvents[i]);event.type+=outside,this.rootBoundary.mapEvent(event)}this.setCursor(this.rootBoundary.cursor)}_onPointerOverOut(nativeEvent){if(!this.features.click)return;this.rootBoundary.rootTarget=this.renderer.lastObjectRendered;const normalizedEvents=this._normalizeToPointerData(nativeEvent);for(let i=0,j=normalizedEvents.length;i<j;i++){const event=this._bootstrapEvent(this._rootPointerEvent,normalizedEvents[i]);this.rootBoundary.mapEvent(event)}this.setCursor(this.rootBoundary.cursor)}onWheel(nativeEvent){if(!this.features.wheel)return;const wheelEvent=this.normalizeWheelEvent(nativeEvent);this.rootBoundary.rootTarget=this.renderer.lastObjectRendered,this.rootBoundary.mapEvent(wheelEvent)}setTargetElement(element){this._removeEvents(),this.domElement=element,EventsTicker.domElement=element,this._addEvents()}_addEvents(){if(this._eventsAdded||!this.domElement)return;EventsTicker.addTickerListener();const style=this.domElement.style;style&&(globalThis.navigator.msPointerEnabled?(style.msContentZooming="none",style.msTouchAction="none"):this.supportsPointerEvents&&(style.touchAction="none")),this.supportsPointerEvents?(globalThis.document.addEventListener("pointermove",this._onPointerMove,!0),this.domElement.addEventListener("pointerdown",this._onPointerDown,!0),this.domElement.addEventListener("pointerleave",this._onPointerOverOut,!0),this.domElement.addEventListener("pointerover",this._onPointerOverOut,!0),globalThis.addEventListener("pointerup",this._onPointerUp,!0)):(globalThis.document.addEventListener("mousemove",this._onPointerMove,!0),this.domElement.addEventListener("mousedown",this._onPointerDown,!0),this.domElement.addEventListener("mouseout",this._onPointerOverOut,!0),this.domElement.addEventListener("mouseover",this._onPointerOverOut,!0),globalThis.addEventListener("mouseup",this._onPointerUp,!0),this.supportsTouchEvents&&(this.domElement.addEventListener("touchstart",this._onPointerDown,!0),this.domElement.addEventListener("touchend",this._onPointerUp,!0),this.domElement.addEventListener("touchmove",this._onPointerMove,!0))),this.domElement.addEventListener("wheel",this.onWheel,{passive:!0,capture:!0}),this._eventsAdded=!0}_removeEvents(){if(!this._eventsAdded||!this.domElement)return;EventsTicker.removeTickerListener();const style=this.domElement.style;style&&(globalThis.navigator.msPointerEnabled?(style.msContentZooming="",style.msTouchAction=""):this.supportsPointerEvents&&(style.touchAction="")),this.supportsPointerEvents?(globalThis.document.removeEventListener("pointermove",this._onPointerMove,!0),this.domElement.removeEventListener("pointerdown",this._onPointerDown,!0),this.domElement.removeEventListener("pointerleave",this._onPointerOverOut,!0),this.domElement.removeEventListener("pointerover",this._onPointerOverOut,!0),globalThis.removeEventListener("pointerup",this._onPointerUp,!0)):(globalThis.document.removeEventListener("mousemove",this._onPointerMove,!0),this.domElement.removeEventListener("mousedown",this._onPointerDown,!0),this.domElement.removeEventListener("mouseout",this._onPointerOverOut,!0),this.domElement.removeEventListener("mouseover",this._onPointerOverOut,!0),globalThis.removeEventListener("mouseup",this._onPointerUp,!0),this.supportsTouchEvents&&(this.domElement.removeEventListener("touchstart",this._onPointerDown,!0),this.domElement.removeEventListener("touchend",this._onPointerUp,!0),this.domElement.removeEventListener("touchmove",this._onPointerMove,!0))),this.domElement.removeEventListener("wheel",this.onWheel,!0),this.domElement=null,this._eventsAdded=!1}mapPositionToPoint(point,x,y){const rect=this.domElement.isConnected?this.domElement.getBoundingClientRect():{width:this.domElement.width,height:this.domElement.height,left:0,top:0},resolutionMultiplier=1/this.resolution;point.x=(x-rect.left)*(this.domElement.width/rect.width)*resolutionMultiplier,point.y=(y-rect.top)*(this.domElement.height/rect.height)*resolutionMultiplier}_normalizeToPointerData(event){const normalizedEvents=[];if(this.supportsTouchEvents&&event instanceof TouchEvent)for(let i=0,li=event.changedTouches.length;i<li;i++){const touch=event.changedTouches[i];typeof touch.button>"u"&&(touch.button=0),typeof touch.buttons>"u"&&(touch.buttons=1),typeof touch.isPrimary>"u"&&(touch.isPrimary=event.touches.length===1&&event.type==="touchstart"),typeof touch.width>"u"&&(touch.width=touch.radiusX||1),typeof touch.height>"u"&&(touch.height=touch.radiusY||1),typeof touch.tiltX>"u"&&(touch.tiltX=0),typeof touch.tiltY>"u"&&(touch.tiltY=0),typeof touch.pointerType>"u"&&(touch.pointerType="touch"),typeof touch.pointerId>"u"&&(touch.pointerId=touch.identifier||0),typeof touch.pressure>"u"&&(touch.pressure=touch.force||.5),typeof touch.twist>"u"&&(touch.twist=0),typeof touch.tangentialPressure>"u"&&(touch.tangentialPressure=0),typeof touch.layerX>"u"&&(touch.layerX=touch.offsetX=touch.clientX),typeof touch.layerY>"u"&&(touch.layerY=touch.offsetY=touch.clientY),touch.isNormalized=!0,touch.type=event.type,normalizedEvents.push(touch)}else if(!globalThis.MouseEvent||event instanceof MouseEvent&&(!this.supportsPointerEvents||!(event instanceof globalThis.PointerEvent))){const tempEvent=event;typeof tempEvent.isPrimary>"u"&&(tempEvent.isPrimary=!0),typeof tempEvent.width>"u"&&(tempEvent.width=1),typeof tempEvent.height>"u"&&(tempEvent.height=1),typeof tempEvent.tiltX>"u"&&(tempEvent.tiltX=0),typeof tempEvent.tiltY>"u"&&(tempEvent.tiltY=0),typeof tempEvent.pointerType>"u"&&(tempEvent.pointerType="mouse"),typeof tempEvent.pointerId>"u"&&(tempEvent.pointerId=MOUSE_POINTER_ID),typeof tempEvent.pressure>"u"&&(tempEvent.pressure=.5),typeof tempEvent.twist>"u"&&(tempEvent.twist=0),typeof tempEvent.tangentialPressure>"u"&&(tempEvent.tangentialPressure=0),tempEvent.isNormalized=!0,normalizedEvents.push(tempEvent)}else normalizedEvents.push(event);return normalizedEvents}normalizeWheelEvent(nativeEvent){const event=this._rootWheelEvent;return this._transferMouseData(event,nativeEvent),event.deltaX=nativeEvent.deltaX,event.deltaY=nativeEvent.deltaY,event.deltaZ=nativeEvent.deltaZ,event.deltaMode=nativeEvent.deltaMode,this.mapPositionToPoint(event.screen,nativeEvent.clientX,nativeEvent.clientY),event.global.copyFrom(event.screen),event.offset.copyFrom(event.screen),event.nativeEvent=nativeEvent,event.type=nativeEvent.type,event}_bootstrapEvent(event,nativeEvent){return event.originalEvent=null,event.nativeEvent=nativeEvent,event.pointerId=nativeEvent.pointerId,event.width=nativeEvent.width,event.height=nativeEvent.height,event.isPrimary=nativeEvent.isPrimary,event.pointerType=nativeEvent.pointerType,event.pressure=nativeEvent.pressure,event.tangentialPressure=nativeEvent.tangentialPressure,event.tiltX=nativeEvent.tiltX,event.tiltY=nativeEvent.tiltY,event.twist=nativeEvent.twist,this._transferMouseData(event,nativeEvent),this.mapPositionToPoint(event.screen,nativeEvent.clientX,nativeEvent.clientY),event.global.copyFrom(event.screen),event.offset.copyFrom(event.screen),event.isTrusted=nativeEvent.isTrusted,event.type==="pointerleave"&&(event.type="pointerout"),event.type.startsWith("mouse")&&(event.type=event.type.replace("mouse","pointer")),event.type.startsWith("touch")&&(event.type=TOUCH_TO_POINTER[event.type]||event.type),event}_transferMouseData(event,nativeEvent){event.isTrusted=nativeEvent.isTrusted,event.srcElement=nativeEvent.srcElement,event.timeStamp=performance.now(),event.type=nativeEvent.type,event.altKey=nativeEvent.altKey,event.button=nativeEvent.button,event.buttons=nativeEvent.buttons,event.client.x=nativeEvent.clientX,event.client.y=nativeEvent.clientY,event.ctrlKey=nativeEvent.ctrlKey,event.metaKey=nativeEvent.metaKey,event.movement.x=nativeEvent.movementX,event.movement.y=nativeEvent.movementY,event.page.x=nativeEvent.pageX,event.page.y=nativeEvent.pageY,event.relatedTarget=null,event.shiftKey=nativeEvent.shiftKey}};_EventSystem.extension={name:"events",type:[ExtensionType.WebGLSystem,ExtensionType.CanvasSystem,ExtensionType.WebGPUSystem],priority:-1};_EventSystem.defaultEventFeatures={move:!0,globalMove:!0,click:!0,wheel:!0};let EventSystem=_EventSystem;const FederatedContainer={onclick:null,onmousedown:null,onmouseenter:null,onmouseleave:null,onmousemove:null,onglobalmousemove:null,onmouseout:null,onmouseover:null,onmouseup:null,onmouseupoutside:null,onpointercancel:null,onpointerdown:null,onpointerenter:null,onpointerleave:null,onpointermove:null,onglobalpointermove:null,onpointerout:null,onpointerover:null,onpointertap:null,onpointerup:null,onpointerupoutside:null,onrightclick:null,onrightdown:null,onrightup:null,onrightupoutside:null,ontap:null,ontouchcancel:null,ontouchend:null,ontouchendoutside:null,ontouchmove:null,onglobaltouchmove:null,ontouchstart:null,onwheel:null,get interactive(){return this.eventMode==="dynamic"||this.eventMode==="static"},set interactive(value){this.eventMode=value?"static":"passive"},_internalEventMode:void 0,get eventMode(){return this._internalEventMode??EventSystem.defaultEventMode},set eventMode(value){this._internalEventMode=value},isInteractive(){return this.eventMode==="static"||this.eventMode==="dynamic"},interactiveChildren:!0,hitArea:null,addEventListener(type,listener,options){const capture=typeof options=="boolean"&&options||typeof options=="object"&&options.capture,signal=typeof options=="object"?options.signal:void 0,once=typeof options=="object"?options.once===!0:!1,context=typeof listener=="function"?void 0:listener;type=capture?`${type}capture`:type;const listenerFn=typeof listener=="function"?listener:listener.handleEvent,emitter=this;signal&&signal.addEventListener("abort",()=>{emitter.off(type,listenerFn,context)}),once?emitter.once(type,listenerFn,context):emitter.on(type,listenerFn,context)},removeEventListener(type,listener,options){const capture=typeof options=="boolean"&&options||typeof options=="object"&&options.capture,context=typeof listener=="function"?void 0:listener;type=capture?`${type}capture`:type,listener=typeof listener=="function"?listener:listener.handleEvent,this.off(type,listener,context)},dispatchEvent(e){if(!(e instanceof FederatedEvent))throw new Error("Container cannot propagate events outside of the Federated Events API");return e.defaultPrevented=!1,e.path=null,e.target=this,e.manager.dispatchEvent(e),!e.defaultPrevented}};extensions.add(AccessibilitySystem);extensions.mixin(Container,accessibilityTarget);extensions.add(EventSystem);extensions.mixin(Container,FederatedContainer);extensions.add(DOMPipe);
